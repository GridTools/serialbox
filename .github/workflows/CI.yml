name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    container: mrtravis/gridtools:gcc-7
    strategy:
      matrix:
        compiler: [g++]

    steps:
    - uses: actions/checkout@v1
    - name: pFUnit
      env:
        PFUNIT_VERSION: 3.2.9
      run: |
        which gfortran-7
        export PFUNIT_FILE=pFUnit-${PFUNIT_VERSION}.tgz
        export PFUNIT_LINK=https://downloads.sourceforge.net/project/pfunit/Source/${PFUNIT_FILE}
        export PFUNIT_DIR=pFUnit-${PFUNIT_VERSION}
        wget $PFUNIT_LINK
        tar xf $PFUNIT_FILE
        cd $PFUNIT_DIR
        mkdir -p build && cd build
        FC=`which gfortran` cmake .. -DCMAKE_INSTALL_PREFIX=${GITHUB_WORKSPACE}/pfunit
        make -j8 install
    - name: configure
      run: mkdir build && cd build && FC=`which gfortran` CXX=`which ${{ matrix.compiler }}` cmake ..
    - name: build
      run: cmake --build build --parallel 2
    - name: test
      run: cd build && ctest
