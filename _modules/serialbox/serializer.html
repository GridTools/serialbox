
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>serialbox.serializer &mdash; Serialbox 2.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/serialbox-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Serialbox 2.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
<div class="logo">
  <a href="../../index.html">
    <img src="../../_static/logo.png"
         alt="Serialbox Logo" width="445" height="170"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Serialbox 2.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for serialbox.serializer</h1><div class="highlight"><pre>
<span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">##===-----------------------------------------------------------------------------*- Python -*-===##</span>
<span class="c1">##</span>
<span class="c1">##                                   S E R I A L B O X</span>
<span class="c1">##</span>
<span class="c1">## This file is distributed under terms of BSD license. </span>
<span class="c1">## See LICENSE.txt for more information.</span>
<span class="c1">##</span>
<span class="c1">##===------------------------------------------------------------------------------------------===##</span>
<span class="c1">##</span>
<span class="c1">## This file contains the Serializer implementation of the Python Interface.</span>
<span class="c1">##</span>
<span class="c1">##===------------------------------------------------------------------------------------------===##</span>

<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">POINTER</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.archive</span> <span class="kn">import</span> <span class="n">Archive</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">get_library</span><span class="p">,</span> <span class="n">extract_string</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">invoke</span><span class="p">,</span> <span class="n">SerialboxError</span>
<span class="kn">from</span> <span class="nn">.fieldmetainfo</span> <span class="kn">import</span> <span class="n">FieldMetainfo</span><span class="p">,</span> <span class="n">FieldMetainfoImpl</span>
<span class="kn">from</span> <span class="nn">.metainfomap</span> <span class="kn">import</span> <span class="n">MetainfoMap</span><span class="p">,</span> <span class="n">MetainfoImpl</span><span class="p">,</span> <span class="n">ArrayOfStringImpl</span>
<span class="kn">from</span> <span class="nn">.savepoint</span> <span class="kn">import</span> <span class="n">Savepoint</span><span class="p">,</span> <span class="n">SavepointImpl</span><span class="p">,</span> <span class="n">SavepointTopCollection</span><span class="p">,</span> <span class="n">SavepointCollection</span>
<span class="kn">from</span> <span class="nn">.type</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">lib</span> <span class="o">=</span> <span class="n">get_library</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SerializerImpl</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Mapping of serialboxSerializer_t &quot;&quot;&quot;</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;impl&quot;</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;ownsData&quot;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">register_library</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># Construction &amp; Destruction</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerCreate</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_int</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerCreate</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerDestroy</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerDestroy</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#</span>
    <span class="c1"># Utility</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetMode</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetMode</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetDirectory</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetDirectory</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_char_p</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetPrefix</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetPrefix</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_char_p</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerUpdateMetaData</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerUpdateMetaData</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxEnableSerialization</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxEnableSerialization</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxDisableSerialization</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxDisableSerialization</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializationStatus</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializationStatus</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerToString</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerToString</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_char_p</span>

    <span class="c1">#</span>
    <span class="c1"># Global Meta-information</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetGlobalMetainfo</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetGlobalMetainfo</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">MetainfoImpl</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#  Register and Query Savepoints</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerAddSavepoint</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                        <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerAddSavepoint</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerHasSavepoint</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                        <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerHasSavepoint</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetNumSavepoints</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetNumSavepoints</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetSavepointVector</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetSavepointVector</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">))</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerDestroySavepointVector</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)),</span>
                                                                  <span class="n">c_int</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerDestroySavepointVector</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnamesAtSavepoint</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                                    <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnamesAtSavepoint</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">ArrayOfStringImpl</span><span class="p">)</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSavepointCreateFromSavepoint</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSavepointCreateFromSavepoint</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#  Register and Query Fields</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerAddField</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span> <span class="n">c_char_p</span><span class="p">,</span>
                                                    <span class="n">POINTER</span><span class="p">(</span><span class="n">FieldMetainfoImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerAddField</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerHasField</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span> <span class="n">c_char_p</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerHasField</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_int</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldMetainfo</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span> <span class="n">c_char_p</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldMetainfo</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">FieldMetainfoImpl</span><span class="p">)</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnames</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnames</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">ArrayOfStringImpl</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Writing &amp; Reading</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerWrite</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                 <span class="n">c_char_p</span><span class="p">,</span>
                                                 <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">),</span>
                                                 <span class="n">c_void_p</span><span class="p">,</span>
                                                 <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                                 <span class="n">c_int</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerWrite</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerRead</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                <span class="n">c_char_p</span><span class="p">,</span>
                                                <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">),</span>
                                                <span class="n">c_void_p</span><span class="p">,</span>
                                                <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                                <span class="n">c_int</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerRead</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerReadSliced</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                      <span class="n">c_char_p</span><span class="p">,</span>
                                                      <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">),</span>
                                                      <span class="n">c_void_p</span><span class="p">,</span>
                                                      <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                                      <span class="n">c_int</span><span class="p">,</span>
                                                      <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerReadSliced</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerReadAsync</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">),</span>
                                                     <span class="n">c_char_p</span><span class="p">,</span>
                                                     <span class="n">POINTER</span><span class="p">(</span><span class="n">SavepointImpl</span><span class="p">),</span>
                                                     <span class="n">c_void_p</span><span class="p">,</span>
                                                     <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                                     <span class="n">c_int</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerReadAsync</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerWaitForAll</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">SerializerImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxSerializerWaitForAll</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#</span>
    <span class="c1"># Stateless Serialization</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxWriteToFile</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_char_p</span><span class="p">,</span>
                                             <span class="n">c_void_p</span><span class="p">,</span>
                                             <span class="n">c_int</span><span class="p">,</span>
                                             <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                             <span class="n">c_int</span><span class="p">,</span>
                                             <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                             <span class="n">c_char_p</span><span class="p">,</span>
                                             <span class="n">c_char_p</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxWriteToFile</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">library</span><span class="o">.</span><span class="n">serialboxReadFromFile</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_char_p</span><span class="p">,</span>
                                              <span class="n">c_void_p</span><span class="p">,</span>
                                              <span class="n">c_int</span><span class="p">,</span>
                                              <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                              <span class="n">c_int</span><span class="p">,</span>
                                              <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int</span><span class="p">),</span>
                                              <span class="n">c_char_p</span><span class="p">,</span>
                                              <span class="n">c_char_p</span><span class="p">]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxReadFromFile</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#</span>
    <span class="c1"># Array</span>
    <span class="c1">#</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxArrayOfStringDestroy</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ArrayOfStringImpl</span><span class="p">)]</span>
    <span class="n">library</span><span class="o">.</span><span class="n">serialboxArrayOfStringDestroy</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="Serializer"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer">[docs]</a><span class="k">class</span> <span class="nc">Serializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serializer implementation of the Python Interface.</span>

<span class="sd">    The serializer is attached to a specific `directory` and to a specific `prefix`, with which</span>
<span class="sd">    all files read and written will start. There are three modes to open a serializer: `Read`,</span>
<span class="sd">    `Write` and `Append` (see :class:`OpenModeKind &lt;serialbox.OpenModeKind&gt;`).</span>
<span class="sd">    `Read` will give a read-only access to the serialized data; `Write` will **erase** all files of</span>
<span class="sd">    a previous run of a serializer with same `directory` and `prefix`; `Append` will import all</span>
<span class="sd">    existing information and allow the user to add more data.</span>

<span class="sd">    It is possible to store multiple serializer in the same directory as long as they differ in</span>
<span class="sd">    their `prefix`.</span>

<span class="sd">    **Example:**</span>
<span class="sd">            &gt;&gt;&gt; field = np.array([1,2,3])</span>
<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; savepoint = Savepoint(&quot;savepoint&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.write(&quot;field&quot;, savepoint, field)</span>
<span class="sd">            &gt;&gt;&gt; [f for f in os.listdir(&quot;.&quot;) if os.path.isfile(os.path.join(&quot;.&quot;, f))] # List files in current directory</span>
<span class="sd">            [&#39;field_field.dat&#39;, &#39;ArchiveMetaData-field.json&#39;, &#39;MetaData-field.json&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Enabled</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Disabled</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="Serializer.__init__"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="s2">&quot;Binary&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Serializer.</span>

<span class="sd">        :param mode: Mode of the Serializer</span>
<span class="sd">        :type mode: OpenModeKind</span>
<span class="sd">        :param directory: The directory where the files will be stored/read (will be created if</span>
<span class="sd">                          necessary)</span>
<span class="sd">        :type directory: str</span>
<span class="sd">        :param prefix: The prefix of the files</span>
<span class="sd">        :type prefix: str</span>
<span class="sd">        :param archive: String used to construct the Archive</span>
<span class="sd">                   (see :func:`Archive.registered_archives &lt;serialbox.Archive.registered_archives&gt;`)</span>
<span class="sd">        :type archive: str</span>
<span class="sd">        :raises serialbox.SerialboxError: if initialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#</span>
        <span class="c1"># Convert mode</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">OpenModeKind</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">value</span>
        <span class="n">modeint</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Validate archive</span>
        <span class="c1">#</span>
        <span class="n">archives</span> <span class="o">=</span> <span class="n">Archive</span><span class="o">.</span><span class="n">registered_archives</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archive</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">archives</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid archive. Registered archives: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">archives</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># Create serializer</span>
        <span class="c1">#</span>
        <span class="n">dirstr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">directory</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prefixstr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">prefix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archivestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">archive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span> <span class="o">=</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerCreate</span><span class="p">,</span> <span class="n">modeint</span><span class="p">,</span> <span class="n">dirstr</span><span class="p">,</span> <span class="n">prefixstr</span><span class="p">,</span>
                                   <span class="n">archivestr</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Savepoint list</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_list</span> <span class="o">=</span> <span class="bp">None</span></div>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#   Utility</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return mode of the Serializer.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.mode</span>
<span class="sd">            &lt;OpenModeKind.Write: 1&gt;</span>

<span class="sd">        :return: Mode of the Serializer</span>
<span class="sd">        :rtype: OpenModeKind</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OpenModeKind</span><span class="p">(</span><span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the prefix of all filenames.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.prefix</span>
<span class="sd">            &#39;field&#39;</span>

<span class="sd">        :return: prefix of all filenames</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetPrefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the directory of the Serializer.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.directory</span>
<span class="sd">            &#39;.&#39;</span>

<span class="sd">        :return: directory of the Serializer</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetDirectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<div class="viewcode-block" id="Serializer.update_meta_data"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.update_meta_data">[docs]</a>    <span class="k">def</span> <span class="nf">update_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write meta-data to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerUpdateMetaData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Serializer.enable"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.enable">[docs]</a>    <span class="k">def</span> <span class="nf">enable</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Enable serialization.</span>

<span class="sd">        Serialization is enabled by default, but it can be disabled either by setting the</span>
<span class="sd">        environment variable ``STELLA_SERIALIZATION_DISABLE`` to a positive value or by calling the</span>
<span class="sd">        function :func:`Serializer.disable &lt;serialbox.Serializer.disable&gt;`.</span>
<span class="sd">        With this function you enable the serialization independently of the current environment.</span>

<span class="sd">        The serialization can be only globally enabled or disabled. There is no way to enable or</span>
<span class="sd">        disable only a specific serializer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxEnableSerialization</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Serializer.disable"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.disable">[docs]</a>    <span class="k">def</span> <span class="nf">disable</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Disable serialization.</span>

<span class="sd">        Serialization is enabled by default, but it can be disabled either by setting the</span>
<span class="sd">        environment variable ``STELLA_SERIALIZATION_DISABLE`` to a positive value or by calling the</span>
<span class="sd">        function :func:`Serializer.disable &lt;serialbox.Serializer.disable&gt;`.</span>
<span class="sd">        With this function you disable the serialization independently of the current environment.</span>

<span class="sd">        The serialization can be only globally enabled or disabled. There is no way to enable or</span>
<span class="sd">        disable only a specific serializer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxDisableSerialization</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Serializer.status"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Get the status of serialization</span>

<span class="sd">        The status is represented as an integer which can take the following values:</span>

<span class="sd">        - 0: the variable is not yet initialized i.e the serialization is enabled if the environment</span>
<span class="sd">          variable ``STELLA_SERIALIZATION_DISABLE`` or ``SERIALBOX_SERIALIZATION_DISABLE`` is not</span>
<span class="sd">          set to a positive value. The first Serializer which is initialized has to set this value</span>
<span class="sd">          either to +1 or to -1 according to the environment.</span>
<span class="sd">        - +1: the serialization is enabled, independently of the environment</span>
<span class="sd">        - -1: the serialization is disabled, independently of the environment</span>

<span class="sd">        See :func:`Serializer.enable &lt;serialbox.Serializer.enable&gt;` and</span>
<span class="sd">        :func:`Serializer.disable &lt;serialbox.Serializer.disable&gt;`.</span>

<span class="sd">        :return: serialization status</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializationStatus</span><span class="p">))</span></div>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#   Global Meta-information</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_metainfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a reference to the global meta-information of the serializer.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.global_metainfo</span>
<span class="sd">            &lt;MetainfoMap {}&gt;</span>
<span class="sd">            &gt;&gt;&gt; ser.global_metainfo.insert(&quot;key&quot;, 5)</span>
<span class="sd">            &gt;&gt;&gt; ser.global_metainfo</span>
<span class="sd">            &lt;MetainfoMap {&quot;key&quot;: 5}&gt;</span>

<span class="sd">        :return: Refrence to the meta-information map</span>
<span class="sd">        :rtype: :class:`MetainfoMap &lt;serialbox.MetainfoMap&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MetainfoMap</span><span class="p">(</span><span class="n">impl</span><span class="o">=</span><span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetGlobalMetainfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">))</span>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#    Register and Query Savepoints</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

<div class="viewcode-block" id="Serializer.register_savepoint"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.register_savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">register_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register `savepoint` within the Serializer.</span>

<span class="sd">        Savepoints can have the same `name` but their meta-data has to be different, thus Savepoints</span>
<span class="sd">        have to be unique.</span>

<span class="sd">        :param savepoint: Savepoint to add</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :raises serialbox.SerialboxError: if `savepoint` already exists within the Serializer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;registering savepoints is not permitted in OpenModeKind.Read&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerAddSavepoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span>
                <span class="s2">&quot;savepoint &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists withing the Serializer&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">savepoint</span><span class="o">.</span><span class="n">__str__</span><span class="p">()))</span></div>

<div class="viewcode-block" id="Serializer.has_savepoint"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.has_savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">has_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if `savepoint` exists within the Serializer.</span>

<span class="sd">        :param savepoint: Savepoint to search for</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :return: `True` if Savepoint exists, `False` otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerHasSavepoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">()))</span></div>

<div class="viewcode-block" id="Serializer.get_savepoint"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.get_savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of Savepoint(s) identified by `name` in the order they were registered</span>

<span class="sd">        The Savepoints in the list are copy-constructed from the Savepoints in the Serializer and</span>
<span class="sd">        inserted in the order they were registered.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.register_savepoint(Savepoint(&quot;sp&quot;, {&quot;key&quot;: 5}))</span>
<span class="sd">            &gt;&gt;&gt; ser.register_savepoint(Savepoint(&quot;sp&quot;, {&quot;key&quot;: 6}))</span>
<span class="sd">            &gt;&gt;&gt; ser.get_savepoint(&quot;sp&quot;)</span>
<span class="sd">            [&lt;Savepoint sp {&quot;key&quot;: 5}&gt;, &lt;Savepoint sp {&quot;key&quot;: 6}&gt;]</span>

<span class="sd">        :param name: Name of the savepoint(s)</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: List of registered Savepoint(s) with ``savepoint.name() == name``</span>
<span class="sd">        :rtype: :class:`list` [:class:`Savepoint &lt;serialbox.Savepoint&gt;`]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepoint_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Serializer.fields_at_savepoint"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.fields_at_savepoint">[docs]</a>    <span class="k">def</span> <span class="nf">fields_at_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of the registered fieldnames at `savepoint`.</span>

<span class="sd">        :param savepoint: Savepoint to use</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :return: list of fieldsnames</span>
<span class="sd">        :rtype: :class:`list` [:class:`str`]</span>
<span class="sd">        :raises serialbox.SerialboxError: if `savepoint` does not exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">savepoint_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnamesAtSavepoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span>
                       <span class="n">savepoint_</span><span class="o">.</span><span class="n">impl</span><span class="p">())</span>
        <span class="n">list_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
            <span class="n">list_array</span> <span class="o">+=</span> <span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxArrayOfStringDestroy</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_array</span></div>

<div class="viewcode-block" id="Serializer.savepoint_list"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.savepoint_list">[docs]</a>    <span class="k">def</span> <span class="nf">savepoint_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of registered savepoints within the Serializer.</span>

<span class="sd">        The Savepoints in the list are copy-constructed from the Savepoints in the Serializer and</span>
<span class="sd">        inserted in the order they were registered.</span>

<span class="sd">        :return: List of registered savepoints</span>
<span class="sd">        :rtype: :class:`list` [:class:`Savepoint &lt;serialbox.Savepoint&gt;`]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Query the savepoint vector</span>
            <span class="c1">#</span>
            <span class="n">vec_savepoint</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetSavepointVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span>
            <span class="n">num_savepoints</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetNumSavepoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Copy the savepoint vector</span>
            <span class="c1">#</span>
            <span class="n">list_of_savepoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_savepoints</span><span class="p">):</span>
                <span class="n">list_of_savepoints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Savepoint</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                 <span class="n">impl</span><span class="o">=</span><span class="n">invoke</span><span class="p">(</span>
                                                     <span class="n">lib</span><span class="o">.</span><span class="n">serialboxSavepointCreateFromSavepoint</span><span class="p">,</span>
                                                     <span class="n">vec_savepoint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contents</span><span class="p">))]</span>
            <span class="c1">#</span>
            <span class="c1"># Destroy the savepoint vector</span>
            <span class="c1">#</span>
            <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerDestroySavepointVector</span><span class="p">,</span> <span class="n">vec_savepoint</span><span class="p">,</span> <span class="n">num_savepoints</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># If we are in Read mode, we can safely cache the savepoint list</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_list</span> <span class="o">=</span> <span class="n">list_of_savepoints</span>

            <span class="k">return</span> <span class="n">list_of_savepoints</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access the savepoint collection of this Serializer</span>

<span class="sd">        Savepoints are primarily identified by their `name` and further distinguished by their</span>
<span class="sd">        `meta_info` but they are unique within the Serializer.</span>

<span class="sd">        Most of the time you will be interested in a particular</span>
<span class="sd">        :class:`Savepoint &lt;serialbox.Savepoint&gt;`. This requires you to specify the meta-information</span>
<span class="sd">        key=value pairs. There are two ways of doing this. But first, recall that there is **NO**</span>
<span class="sd">        ordering in the meta-information, hence it does not matter in which sequence you specify</span>
<span class="sd">        them! Consider the following example in which we register two savepoints, both named</span>
<span class="sd">        identically but with slightly different meta-information:</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.register_savepoint(Savepoint(&quot;my-savepoint&quot;, {&quot;key1&quot;: 5, &quot;key2&quot;: &quot;str&quot;}))</span>
<span class="sd">            &gt;&gt;&gt; ser.register_savepoint(Savepoint(&quot;my-savepoint&quot;, {&quot;key1&quot;: 6, &quot;key2&quot;: &quot;str&quot;}))</span>

<span class="sd">        To access the first savepoint (i.e the one with ``key=5``) we can use the element access:</span>

<span class="sd">            &gt;&gt;&gt; ser.savepoint[&quot;my-savepoint&quot;][&quot;key1&quot;][5][&quot;key2&quot;][&quot;str&quot;]</span>
<span class="sd">            &lt;SavepointCollection [my-savepoint {&quot;key2&quot;: str, &quot;key1&quot;: 5}]&gt;</span>

<span class="sd">        Note that a :class:`SavepointCollection &lt;serialbox.SavepointCollection&gt;` can be converted</span>
<span class="sd">        to a :class:`Savepoint &lt;serialbox.Savepoint&gt;` (See</span>
<span class="sd">        :func:`SavepointCollection.as_savepoint() &lt;serialbox.SavepointCollection.as_savepoint()&gt;`)</span>

<span class="sd">        Again, the order in which you access the meta-information does not matter, meaning the</span>
<span class="sd">        follwoing is completely identical:</span>

<span class="sd">            &gt;&gt;&gt; ser.savepoint[&quot;my-savepoint&quot;][&quot;key2&quot;][&quot;str&quot;][&quot;key1&quot;][5]</span>
<span class="sd">            &lt;SavepointCollection [my-savepoint {&quot;key2&quot;: str, &quot;key1&quot;: 5}]&gt;</span>

<span class="sd">        The second way uses the member access of python which can be more convenient. Note that this</span>
<span class="sd">        way has some downsides if you don&#39;t use savepoint names or keys which can be mapped to valid</span>
<span class="sd">        Python identifiers. For example instead of using a &#39;.&#39; you can use &#39;_&#39;, same goes for &#39;-&#39;.</span>
<span class="sd">        Therefore, we can also write:</span>

<span class="sd">            &gt;&gt;&gt; ser.savepoint.my_savepoint.key1[5].key2[&quot;str&quot;]</span>
<span class="sd">            &lt;SavepointCollection [my-savepoint {&quot;key2&quot;: str, &quot;key1&quot;: 5}]&gt;</span>

<span class="sd">        The following transformations are applied to construct a valid Python identifier.</span>

<span class="sd">        ==========  ===========</span>
<span class="sd">        Character   Replacement</span>
<span class="sd">        ==========  ===========</span>
<span class="sd">        ``-``       ``_``</span>
<span class="sd">        ``.``       ``_``</span>
<span class="sd">        ``[0-9]``   ``_[0-9]``</span>
<span class="sd">        ==========  ===========</span>

<span class="sd">        It is also possible to mix the two approaches and thus bypass any problems with the</span>
<span class="sd">        identifiers.</span>

<span class="sd">            &gt;&gt;&gt; ser.savepoint[&quot;my-savepoint&quot;].key1[5].key2[&quot;str&quot;]</span>
<span class="sd">            &lt;SavepointCollection [my-savepoint {&quot;key2&quot;: str, &quot;key1&quot;: 5}]&gt;</span>

<span class="sd">        :return: Collection of all savepoints</span>
<span class="sd">        :rtype: :class:`SavepointCollection &lt;serialbox.SavepointCollection&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SavepointTopCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savepoint_list</span><span class="p">())</span>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#    Register and Query Fields</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

<div class="viewcode-block" id="Serializer.register_field"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.register_field">[docs]</a>    <span class="k">def</span> <span class="nf">register_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fieldmetainfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add field given by `name` with field meta-information `fieldmetainfo` to the Serializer.</span>

<span class="sd">        The `write` methods can do the registration implicitly.</span>

<span class="sd">        :param name: Name of the newly registered field</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param fieldmetainfo: Field meta-information of the newly registered field</span>
<span class="sd">        :type fieldmetainfo: FieldMetainfo</span>
<span class="sd">        :raises serialbox.SerialboxError: if field with given name already exists within the</span>
<span class="sd">                                          Serializer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;registering fields is not permitted in OpenModeKind.Read&quot;</span><span class="p">)</span>

        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerAddField</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">namestr</span><span class="p">,</span>
                      <span class="n">fieldmetainfo</span><span class="o">.</span><span class="n">impl</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;field &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists within the Serializer&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Serializer.has_field"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.has_field">[docs]</a>    <span class="k">def</span> <span class="nf">has_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if `field` is registered within the Serializer.</span>

<span class="sd">        :param field: Name of the field to check for</span>
<span class="sd">        :type field: str</span>
<span class="sd">        :return: `True` if field exists, `False` otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerHasField</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">))</span></div>

<div class="viewcode-block" id="Serializer.get_field_metainfo"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.get_field_metainfo">[docs]</a>    <span class="k">def</span> <span class="nf">get_field_metainfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the :class:`FieldMetainfo &lt;serialbox.FieldMetainfo&gt;` of `field`.</span>

<span class="sd">        :param field: Name of the field</span>
<span class="sd">        :type field: str</span>
<span class="sd">        :return: Copy of the field meta-information of `field`</span>
<span class="sd">        :rtype: :class:`FieldMetainfo &lt;serialbox.FieldMetainfo&gt;`</span>
<span class="sd">        :raises serialbox.SerialboxError: if `field` does not exist within the Serializer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">FieldMetainfo</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[],</span>
                             <span class="n">impl</span><span class="o">=</span><span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldMetainfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span>
                                         <span class="n">fieldstr</span><span class="p">))</span></div>

<div class="viewcode-block" id="Serializer.fieldnames"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.fieldnames">[docs]</a>    <span class="k">def</span> <span class="nf">fieldnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of registered fieldnames within the Serializer.</span>

<span class="sd">        :return: list of fieldnames</span>
<span class="sd">        :rtype: :class:`list` [:class:`str`]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerGetFieldnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span>
        <span class="n">list_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
            <span class="n">list_array</span> <span class="o">+=</span> <span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxArrayOfStringDestroy</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_array</span></div>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#    Writing &amp; Reading</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract strides from a numpy.array and convert to unit-strides, returns a C-Array and its</span>
<span class="sd">           size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_int</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strides</span><span class="p">))()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strides</span><span class="p">)):</span>
            <span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">num_strides</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strides</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span><span class="p">,</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__extract_dims</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract dimensions from a numpy.array, returns a C-Array and its size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_int</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">))()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">num_dims</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the savepoint of a savepoint collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">savepoint</span><span class="p">,</span> <span class="n">SavepointCollection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">as_savepoint</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">savepoint</span>

    <span class="k">def</span> <span class="nf">__allocate_or_check_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocate or check the numpy field for consistency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;field &#39;</span><span class="si">%s</span><span class="s2">&#39; is not registered within the Serializer&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_metainfo</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">typeID2numpy</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span>
                    <span class="s2">&quot;registered dimensions </span><span class="si">%s</span><span class="s2"> do not match dimensions of field (</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">numpy2TypeID</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span>
                    <span class="s2">&quot;registered type </span><span class="si">%s</span><span class="s2"> does not match type of field (</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">numpy2TypeID</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">info</span><span class="p">,)</span>

<div class="viewcode-block" id="Serializer.write"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">register_field</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Serialize `field` identified by `name` at `savepoint` to disk</span>

<span class="sd">        The `savepoint` will be registered at field `name` if not yet present. If `register_field`</span>
<span class="sd">        is `True`, the field will be registered if necessary.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; field = np.random.rand(3,3)</span>
<span class="sd">            &gt;&gt;&gt; ser.write(&quot;myfield&quot;, Savepoint(&quot;mysavepoint&quot;), field)</span>
<span class="sd">            &gt;&gt;&gt; ser.has_field(&quot;myfield&quot;)</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; ser.fields_at_savepoint(Savepoint(&quot;mysavepoint&quot;))</span>
<span class="sd">            [&#39;myfield&#39;]</span>

<span class="sd">        :param name: Name of the field</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param savepoint: Savepoint at which the field will be serialized</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :param field: Field to serialize</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :param register_field: Register the field if not present</span>
<span class="sd">        :type register_field: bool</span>

<span class="sd">        :raises serialbox.SerialboxError: if serialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;write operations are not permitted in OpenModeKind.Read&quot;</span><span class="p">)</span>

        <span class="n">savepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">register_field</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">FieldMetainfo</span><span class="p">(</span><span class="n">numpy2TypeID</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;field &#39;</span><span class="si">%s</span><span class="s2">&#39; is not registered within the Serializer&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Extract strides and convert to unit-strides</span>
        <span class="c1">#</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Write to disk</span>
        <span class="c1">#</span>
        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerWrite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">namestr</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">(),</span>
               <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span><span class="p">)</span></div>

<div class="viewcode-block" id="Serializer.read"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deserialize `field` identified by `name` at `savepoint` from disk</span>

<span class="sd">        If `field` is a :class:`numpy.array &lt;numpy.array&gt;` it will be filled with data from disk.</span>
<span class="sd">        If `field` is ``None``, a new numpy.array will be allocated with the registered dimensions</span>
<span class="sd">        and type.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Read, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.fieldnames()</span>
<span class="sd">            [&#39;myfield&#39;]</span>
<span class="sd">            &gt;&gt;&gt; ser.get_field_metainfo(&quot;myfield&quot;)</span>
<span class="sd">            &lt;FieldMetainfo type = double, dims = [3, 3], metainfo = {}&gt;</span>
<span class="sd">            &gt;&gt;&gt; field = ser.read(&quot;myfield&quot;, Savepoint(&quot;mysavepoint&quot;))</span>
<span class="sd">            &gt;&gt;&gt; field</span>
<span class="sd">            array([[ 0.56079736,  0.21627747,  0.87964583],</span>
<span class="sd">                   [ 0.94684836,  0.12496717,  0.47460455],</span>
<span class="sd">                   [ 0.11462436,  0.86608157,  0.57855988]])</span>

<span class="sd">        :param name: Name of the field</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param savepoint: Savepoint at which the field will be deserialized</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :param field: Field to fill or ``None``</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :return: Newly allocated and deserialized field</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        :raises serialbox.SerialboxError: if deserialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;read operations are not permitted in OpenModeKind.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="n">savepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Allocate or check the field</span>
        <span class="c1">#</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allocate_or_check_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Extract strides and convert to unit-strides</span>
        <span class="c1">#</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Read from disk</span>
        <span class="c1">#</span>
        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerRead</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">namestr</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">(),</span>
               <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field</span></div>

<div class="viewcode-block" id="Serializer.read_async"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.read_async">[docs]</a>    <span class="k">def</span> <span class="nf">read_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Asynchronously deserialize field `name` (given as `storageView`) at `savepoint` from</span>
<span class="sd">        disk using ``std::async``.</span>

<span class="sd">        If `field` is a :class:`numpy.array &lt;numpy.array&gt;` it will be filled with data from disk.</span>
<span class="sd">        If `field` is ``None``, a new numpy.array will be allocated with the registered dimensions</span>
<span class="sd">        and type.</span>

<span class="sd">        This method runs the :func:`Serializer.read &lt;serialbox.Serializer.read&gt;` function</span>
<span class="sd">        asynchronously (potentially in a separate thread which may be part of a thread pool),</span>
<span class="sd">        meaning this function immediately returns. To synchronize all threads, use</span>
<span class="sd">        :func:`Serializer.wait_for_all &lt;serialbox.Serializer.wait_for_all&gt;`.</span>

<span class="sd">        If the archive is not thread-safe or if the library was not configured with</span>
<span class="sd">        ``SERIALBOX_ASYNC_API`` the method falls back to synchronous execution.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Read, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.fieldnames()</span>
<span class="sd">            [&#39;field_1&#39;, &#39;field_2&#39;, &#39;field_3&#39;]</span>
<span class="sd">            &gt;&gt;&gt; field_1 = ser.read_async(&quot;field1&quot;, Savepoint(&quot;sp&quot;))</span>
<span class="sd">            &gt;&gt;&gt; field_2 = ser.read_async(&quot;field2&quot;, Savepoint(&quot;sp&quot;))</span>
<span class="sd">            &gt;&gt;&gt; field_3 = ser.read_async(&quot;field3&quot;, Savepoint(&quot;sp&quot;))</span>
<span class="sd">            &gt;&gt;&gt; ser.wait_for_all()</span>

<span class="sd">        :param name: Name of the field</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param savepoint: Savepoint at which the field will be deserialized</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :param field: Field to fill or ``None``</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :return: Newly allocated and deserialized field</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        :raises SerialboxError: Deserialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;read operations are not permitted in OpenModeKind.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="n">savepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Allocate or check the field</span>
        <span class="c1">#</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allocate_or_check_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Extract strides and convert to unit-strides</span>
        <span class="c1">#</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Read from disk</span>
        <span class="c1">#</span>
        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerReadAsync</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">namestr</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">(),</span>
               <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field</span></div>

<div class="viewcode-block" id="Serializer.wait_for_all"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.wait_for_all">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wait for all pending asynchronous read operations and reset the internal queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerWaitForAll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span></div>

<div class="viewcode-block" id="Serializer.read_slice"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.read_slice">[docs]</a>    <span class="k">def</span> <span class="nf">read_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">savepoint</span><span class="p">,</span> <span class="n">slice_obj</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deserialize sliced `field` identified by `name`  and `slice` at `savepoint` from disk</span>

<span class="sd">        The method will allocate a `numpy.array` with the registered dimensions and type and fill it</span>
<span class="sd">        at specified positions (given by `slice_obj`) with data from disk. If `field` is a</span>
<span class="sd">        :class:`numpy.array &lt;numpy.array&gt;` it will be filled with data from disk. If `field` is</span>
<span class="sd">        ``None``, a new numpy.array will be allocated with the registered dimensions and type.</span>

<span class="sd">        Assume we are given a three-dimensional field but we are only interested in a certain layer</span>
<span class="sd">        of the data (``k = 50``), we can use the slice object (ser.Slice) to encode this information</span>
<span class="sd">        and instruct the serializer to only load the desired data. Note that we still need to</span>
<span class="sd">        allocate memory for the whole field.</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Read, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser.fieldnames()</span>
<span class="sd">            [&#39;field&#39;]</span>
<span class="sd">            &gt;&gt;&gt; ser.get_field_metainfo(&quot;field&quot;)</span>
<span class="sd">            &lt;FieldMetainfo type = double, dims = [1024, 1024, 80], metainfo = {}&gt;</span>
<span class="sd">            &gt;&gt;&gt; field = np.zeros(1024, 1024, 80)</span>
<span class="sd">            &gt;&gt;&gt; ser.read_slice(&#39;field&#39;, Savepoint(&quot;sp&quot;), ser.Slice[:, :, 50], field)</span>

<span class="sd">        You can of course load the full data and slice it afterwards with numpy which yields the</span>
<span class="sd">        same result, though is most likely slower.</span>

<span class="sd">            &gt;&gt;&gt; ser.read(&#39;field&#39;, Savepoint(&quot;sp&quot;), field)[:, :, 50]</span>

<span class="sd">        :type name: str</span>
<span class="sd">        :param savepoint: Savepoint at which the field will be deserialized</span>
<span class="sd">        :type savepoint: Savepoint</span>
<span class="sd">        :param slice_obj: Slice of the data to load</span>
<span class="sd">        :type slice_obj: :class:`Slice &lt;serialbox._Slice&gt;`</span>
<span class="sd">        :param field: Field to fill or ``None``</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :return: Newly allocated and deserialized field</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        :raises serialbox.SerialboxError: if deserialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">savepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_savepoint</span><span class="p">(</span><span class="n">savepoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OpenModeKind</span><span class="o">.</span><span class="n">Read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;read operations are not permitted in OpenModeKind.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Allocate or check the field</span>
        <span class="c1">#</span>
        <span class="n">field</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allocate_or_check_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Extract strides and convert to unit-strides</span>
        <span class="c1">#</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Construct slice array</span>
        <span class="c1">#</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">dims</span>
        <span class="n">num_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

        <span class="n">c_slice_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_int</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">num_dims</span><span class="p">))()</span>

        <span class="c1"># Convert slice_obj to list</span>
        <span class="n">slice_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slice_obj</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">slice_array</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slice_obj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">slice_obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerialboxError</span><span class="p">(</span><span class="s2">&quot;number of slices (</span><span class="si">%i</span><span class="s2">) exceeds number of dimensions (</span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">slice_array</span><span class="p">),</span> <span class="n">num_dims</span><span class="p">))</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_array</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_dims</span><span class="p">:</span>
            <span class="n">slice_array</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_dims</span><span class="p">):</span>
            <span class="n">slice_triple</span> <span class="o">=</span> <span class="n">slice_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slice_triple</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># start</span>
                <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_triple</span>

                <span class="c1"># stop</span>
                <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_triple</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># end</span>
                <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># start</span>
                <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">start</span>

                <span class="c1"># stop (expand negative values)</span>
                <span class="k">if</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">stop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">stop</span>

                <span class="c1"># end</span>
                <span class="n">c_slice_array</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">slice_triple</span><span class="o">.</span><span class="n">step</span>

        <span class="c1">#</span>
        <span class="c1"># Read from disk</span>
        <span class="c1">#</span>
        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerReadSliced</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">,</span> <span class="n">namestr</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">.</span><span class="n">impl</span><span class="p">(),</span>
               <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span><span class="p">,</span> <span class="n">c_slice_array</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field</span></div>

    <span class="c1"># ===----------------------------------------------------------------------------------------===</span>
    <span class="c1">#    Stateless Serialization</span>
    <span class="c1"># ==-----------------------------------------------------------------------------------------===</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Serializer.to_file"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Serialize `field` identified by `name` directly to file.</span>

<span class="sd">        This method allows stateless serializations i.e serialize fields without the need to</span>
<span class="sd">        register fields or savpoints.</span>

<span class="sd">        If a file with `filename` already exists, it&#39;s contents will be discarded. If `archive` is</span>
<span class="sd">        ``None``, the method will try to deduce the archive using the extensions of `filename`</span>
<span class="sd">        (See :func:`Archive.archive_from_extension() &lt;serialbox.Archive.archive_from_extension&gt;`).</span>

<span class="sd">            &gt;&gt;&gt; field = np.random.rand(3,3)</span>
<span class="sd">            &gt;&gt;&gt; Serializer.to_file(&quot;field&quot;, field, &quot;field.dat&quot;)</span>

<span class="sd">        :param name: Name of the field (may not be needed for certain archives)</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param field: Field to serialize</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :param name: Name of the file</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :raises serialbox.SerialboxError: if archive could not be deduced or deserialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="n">Serializer</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">dims</span><span class="p">,</span> <span class="n">num_dims</span> <span class="o">=</span> <span class="n">Serializer</span><span class="o">.</span><span class="n">__extract_dims</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="o">.</span><span class="n">archive_from_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">typeint</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="n">numpy2TypeID</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archivestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">archive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxWriteToFile</span><span class="p">,</span> <span class="n">filestr</span><span class="p">,</span> <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">typeint</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span>
               <span class="n">namestr</span><span class="p">,</span> <span class="n">archivestr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Serializer.from_file"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deserialize `field` identified by `name` directly from file.</span>

<span class="sd">        This method allows stateless deserializations i.e serialize fields without specifying the</span>
<span class="sd">        savepoints or fields.</span>

<span class="sd">        If `archive` is ``None``, the method will try to deduce the archive using the extensions</span>
<span class="sd">        of `filename` (See</span>
<span class="sd">        :func:`Archive.archive_from_extension() &lt;serialbox.Archive.archive_from_extension&gt;`).</span>

<span class="sd">            &gt;&gt;&gt; field = np.zeros((3,3))</span>
<span class="sd">            &gt;&gt;&gt; field = Serializer.from_file(&quot;field&quot;, field, &quot;field.dat&quot;)</span>
<span class="sd">            &gt;&gt;&gt; field</span>
<span class="sd">            array([[ 0.56079736,  0.21627747,  0.87964583],</span>
<span class="sd">                   [ 0.94684836,  0.12496717,  0.47460455],</span>
<span class="sd">                   [ 0.11462436,  0.86608157,  0.57855988]])</span>

<span class="sd">        .. warning::</span>

<span class="sd">           This method performs no consistency checks concerning the dimensions and type of the</span>
<span class="sd">           data. You have to know what you are doing!</span>

<span class="sd">        :param name: Name of the field (may not be needed for certain archives)</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param field: Field to serialize</span>
<span class="sd">        :type field: numpy.array</span>
<span class="sd">        :param name: Name of the file</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :raises serialbox.SerialboxError: if archive could not be deduced or deserialization failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strides</span><span class="p">,</span> <span class="n">num_strides</span> <span class="o">=</span> <span class="n">Serializer</span><span class="o">.</span><span class="n">__extract_strides</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">dims</span><span class="p">,</span> <span class="n">num_dims</span> <span class="o">=</span> <span class="n">Serializer</span><span class="o">.</span><span class="n">__extract_dims</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="o">.</span><span class="n">archive_from_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">origin_ptr</span> <span class="o">=</span> <span class="n">c_void_p</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">typeint</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="n">numpy2TypeID</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archivestr</span> <span class="o">=</span> <span class="n">extract_string</span><span class="p">(</span><span class="n">archive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxReadFromFile</span><span class="p">,</span> <span class="n">filestr</span><span class="p">,</span> <span class="n">origin_ptr</span><span class="p">,</span> <span class="n">typeint</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span>
               <span class="n">namestr</span><span class="p">,</span> <span class="n">archivestr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">:</span>
            <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerDestroy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span>

<div class="viewcode-block" id="Serializer.__str__"><a class="viewcode-back" href="../../Python.html#serialbox.Serializer.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert Serializer to string</span>

<span class="sd">            &gt;&gt;&gt; ser = Serializer(OpenModeKind.Write, &quot;.&quot;, &quot;field&quot;, &quot;Binary&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ser</span>
<span class="sd">            &lt;Serializer mode = Write</span>
<span class="sd">            directory = &quot;.&quot;</span>
<span class="sd">            prefix = &quot;field&quot;</span>
<span class="sd">            archive = &quot;Binary&quot;</span>
<span class="sd">            metainfo = {}</span>
<span class="sd">            savepoints = []</span>
<span class="sd">            fieldmetainfo = []&gt;</span>

<span class="sd">        :return: Multi-line string representation of the Serializer</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">invoke</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">serialboxSerializerToString</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serializer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Serializer {0}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span></div>


<span class="n">register_library</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Serialbox 2.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Fabian Thüring.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>