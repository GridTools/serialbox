MODULE serialbox_test
   
  USE ISO_FORTRAN_ENV
  USE pfunit_mod
  USE m_serialize
  USE iso_c_binding
  
  IMPLICIT NONE
  
  PUBLIC 

  TYPE(t_savepoint)  :: savepoint
  
  CHARACTER(len=*), PARAMETER :: dir = 'sbdata'
  CHARACTER(len=*), PARAMETER :: savepoint_name = 'test'
  INTEGER, PARAMETER :: exp_size_scalar(4) = (/ 1, 0, 0, 0 /) 
  INTEGER, PARAMETER :: exp_halos_scalar(8) = (/ 0, 0, 0, 0, 0, 0, 0, 0 /) 

CONTAINS
   
   FUNCTION exp_size(var_shape)
      INTEGER :: var_shape(:), exp_size(4)
      exp_size = RESHAPE(var_shape, (/ 4 /), (/ 0, 0, 0, 0 /))
   END FUNCTION exp_size

@Before
   SUBROUTINE mySetup()

      CALL fs_create_savepoint(savepoint_name, savepoint)
      
   END SUBROUTINE mySetup
   
@After
   SUBROUTINE myTearDown()

      CALL fs_destroy_savepoint(savepoint)
      
   END SUBROUTINE myTearDown
   
@Test
    SUBROUTINE testIntegerArrays()
    
      TYPE(t_serializer) :: serializer
      INTEGER :: w_testfield_i1(5), w_testfield_i2(4,3), w_testfield_i3(3,2,2), w_testfield_i4(2,2,2,2)
      INTEGER :: r_testfield_i1(5), r_testfield_i2(4,3), r_testfield_i3(3,2,2), r_testfield_i4(2,2,2,2)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_integer'
      
      w_testfield_i1 = (/ 0, 1, 2, 3, 4 /)
      w_testfield_i2 = RESHAPE((/ 0, 3, 2, 9, 1, 4, 7, 10, 2, 5, 8, 11 /), SHAPE(w_testfield_i2))
      w_testfield_i3 = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i3))
      w_testfield_i4 = RESHAPE((/ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 /), SHAPE(w_testfield_i4))
            
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_i1", w_testfield_i1)
      CALL fs_write_field(serializer, savepoint, "testfield_i2", w_testfield_i2)
      CALL fs_write_field(serializer, savepoint, "testfield_i3", w_testfield_i3)
      CALL fs_write_field(serializer, savepoint, "testfield_i4", w_testfield_i4)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertTrue(fs_field_exists(serializer, "testfield_i1"))
      @assertTrue(fs_field_exists(serializer, "testfield_i2"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4"))
      @assertEqual(exp_size(SHAPE(w_testfield_i1)), fs_get_size(serializer, "testfield_i1"))
      @assertEqual(exp_size(SHAPE(w_testfield_i2)), fs_get_size(serializer, "testfield_i2"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3)), fs_get_size(serializer, "testfield_i3"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4)), fs_get_size(serializer, "testfield_i4"))
      CALL fs_read_field(serializer, savepoint, "testfield_i1", r_testfield_i1)
      CALL fs_read_field(serializer, savepoint, "testfield_i2", r_testfield_i2)
      CALL fs_read_field(serializer, savepoint, "testfield_i3", r_testfield_i3)
      CALL fs_read_field(serializer, savepoint, "testfield_i4", r_testfield_i4)
      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_i1, r_testfield_i1)
      @assertEqual(w_testfield_i2, r_testfield_i2)
      @assertEqual(w_testfield_i3, r_testfield_i3)
      @assertEqual(w_testfield_i4, r_testfield_i4)
    
    END SUBROUTINE testIntegerArrays
   
@Test
    SUBROUTINE testLongArrays()
    
      TYPE(t_serializer) :: serializer
      INTEGER(KIND=8) :: w_testfield_long1(5), w_testfield_long2(4,3), w_testfield_long3(3,2,2), w_testfield_long4(2,2,2,2)
      INTEGER(KIND=8) :: r_testfield_long1(5), r_testfield_long2(4,3), r_testfield_long3(3,2,2), r_testfield_long4(2,2,2,2)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_long'
      
      w_testfield_long1 = (/ 0_8, 1_8, 2_8, 3_8, 999888777666555_8 /)
      w_testfield_long2 = RESHAPE((/ 0_8, 3_8, 2_8, 9223372036854775807_8, 1_8, 4_8, 7_8, 10_8, 2_8, 5_8, 8_8, 11_8 /), SHAPE(w_testfield_long2))
      w_testfield_long3 = RESHAPE((/ 0_8, 4_8, 8_8, 2_8, 6_8, 10_8, 1_8, 5_8, -9223372036854775807_8, 3_8, 7_8, 11_8 /), SHAPE(w_testfield_long3))
      w_testfield_long4 = RESHAPE((/ 0_8, 1_8, 2_8, 3_8, 4_8, 5_8, 6_8, 7_8, 2147483647_8, 2147483648_8, -2147483648_8, -2147483649_8, 12_8, 13_8, 14_8, 15_8 /), SHAPE(w_testfield_long4))
            
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_long1", w_testfield_long1)
      CALL fs_write_field(serializer, savepoint, "testfield_long2", w_testfield_long2)
      CALL fs_write_field(serializer, savepoint, "testfield_long3", w_testfield_long3)
      CALL fs_write_field(serializer, savepoint, "testfield_long4", w_testfield_long4)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertTrue(fs_field_exists(serializer, "testfield_long1"))
      @assertTrue(fs_field_exists(serializer, "testfield_long2"))
      @assertTrue(fs_field_exists(serializer, "testfield_long3"))
      @assertTrue(fs_field_exists(serializer, "testfield_long4"))
      @assertEqual(exp_size(SHAPE(w_testfield_long1)), fs_get_size(serializer, "testfield_long1"))
      @assertEqual(exp_size(SHAPE(w_testfield_long2)), fs_get_size(serializer, "testfield_long2"))
      @assertEqual(exp_size(SHAPE(w_testfield_long3)), fs_get_size(serializer, "testfield_long3"))
      @assertEqual(exp_size(SHAPE(w_testfield_long4)), fs_get_size(serializer, "testfield_long4"))
      CALL fs_read_field(serializer, savepoint, "testfield_long1", r_testfield_long1)
      CALL fs_read_field(serializer, savepoint, "testfield_long2", r_testfield_long2)
      CALL fs_read_field(serializer, savepoint, "testfield_long3", r_testfield_long3)
      CALL fs_read_field(serializer, savepoint, "testfield_long4", r_testfield_long4)
      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_long1, r_testfield_long1)
      @assertEqual(w_testfield_long2, r_testfield_long2)
      @assertEqual(w_testfield_long3, r_testfield_long3)
      @assertEqual(w_testfield_long4, r_testfield_long4)
    
    END SUBROUTINE testLongArrays
   
@Test
    SUBROUTINE testLogicalArrays()
    
      TYPE(t_serializer) :: serializer
      LOGICAL :: w_testfield_l1(5), w_testfield_l2(4,3), w_testfield_l3(3,2,2), w_testfield_l4(2,2,2,2)
      LOGICAL :: r_testfield_l1(5), r_testfield_l2(4,3), r_testfield_l3(3,2,2), r_testfield_l4(2,2,2,2)
      INTEGER :: w_testfield_i2(4,3), w_testfield_i3(3,2,2), w_testfield_i4(2,2,2,2)
      INTEGER :: r_testfield_i2(4,3), r_testfield_i3(3,2,2), r_testfield_i4(2,2,2,2)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_logical'
      
      w_testfield_l1 = (/ .TRUE., .FALSE., .FALSE., .TRUE., .FALSE. /)
      w_testfield_l2 = RESHAPE((/ .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE. /), SHAPE(w_testfield_l2))
      w_testfield_l3 = RESHAPE((/ .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE. /), SHAPE(w_testfield_l3))
      w_testfield_l4 = RESHAPE((/ .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE., .FALSE., .FALSE., .TRUE., .FALSE., .TRUE. /), SHAPE(w_testfield_l4))
            
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_l1", w_testfield_l1)
      CALL fs_write_field(serializer, savepoint, "testfield_l2", w_testfield_l2)
      CALL fs_write_field(serializer, savepoint, "testfield_l3", w_testfield_l3)
      CALL fs_write_field(serializer, savepoint, "testfield_l4", w_testfield_l4)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertTrue(fs_field_exists(serializer, "testfield_l1"))
      @assertTrue(fs_field_exists(serializer, "testfield_l2"))
      @assertTrue(fs_field_exists(serializer, "testfield_l3"))
      @assertTrue(fs_field_exists(serializer, "testfield_l4"))
      @assertEqual(exp_size(SHAPE(w_testfield_l1)), fs_get_size(serializer, "testfield_l1"))
      @assertEqual(exp_size(SHAPE(w_testfield_l2)), fs_get_size(serializer, "testfield_l2"))
      @assertEqual(exp_size(SHAPE(w_testfield_l3)), fs_get_size(serializer, "testfield_l3"))
      @assertEqual(exp_size(SHAPE(w_testfield_l4)), fs_get_size(serializer, "testfield_l4"))
      CALL fs_read_field(serializer, savepoint, "testfield_l1", r_testfield_l1)
      CALL fs_read_field(serializer, savepoint, "testfield_l2", r_testfield_l2)
      CALL fs_read_field(serializer, savepoint, "testfield_l3", r_testfield_l3)
      CALL fs_read_field(serializer, savepoint, "testfield_l4", r_testfield_l4)
      CALL fs_destroy_serializer(serializer)
      
      @assertEquivalent(w_testfield_l1, r_testfield_l1)
      
      !Convert to INTEGER since pFUnit doesn't support multi-dimensional LOGICAL arrays
      w_testfield_i2 = w_testfield_l2
      r_testfield_i2 = r_testfield_l2
      @assertEqual(w_testfield_i2, r_testfield_i2)
      w_testfield_i3 = w_testfield_l3
      r_testfield_i3 = r_testfield_l3
      @assertEqual(w_testfield_i3, r_testfield_i3)
      w_testfield_i4 = w_testfield_l4
      r_testfield_i4 = r_testfield_l4
      @assertEqual(w_testfield_i4, r_testfield_i4)
    
    END SUBROUTINE testLogicalArrays
   
@Test
    SUBROUTINE testScalars()
    
      TYPE(t_serializer) :: serializer
      INTEGER :: w_testfield_i0, r_testfield_i0
      INTEGER :: w_testfield_i1(1), r_testfield_i1(1)
      LOGICAL :: w_testfield_l0, r_testfield_l0
      LOGICAL :: w_testfield_l1(1), r_testfield_l1(1)
      INTEGER(8) :: w_testfield_long0, r_testfield_long0
      INTEGER(8) :: w_testfield_long1(1), r_testfield_long1(1)
      REAL(KIND=C_FLOAT)  :: w_testfield_f0, r_testfield_f0
      REAL(KIND=C_DOUBLE) :: w_testfield_d0, r_testfield_d0
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_scalars'
      
      w_testfield_i0 = 42
      w_testfield_i1 = (/ 999 /)
      w_testfield_l0 = .TRUE.
      w_testfield_l1 = (/ .FALSE. /)
      w_testfield_long0 = 999888777666555_8
      w_testfield_long1 = (/ -1234567890123_8 /)
      w_testfield_f0 = 3.14159274
      w_testfield_d0 = 3.1415926535897931
            
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_i0", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "testfield_i1", w_testfield_i1)
      CALL fs_write_field(serializer, savepoint, "testfield_l0", w_testfield_l0)
      CALL fs_write_field(serializer, savepoint, "testfield_l1", w_testfield_l1)
      CALL fs_write_field(serializer, savepoint, "testfield_long0", w_testfield_long0)
      CALL fs_write_field(serializer, savepoint, "testfield_long1", w_testfield_long1)
      CALL fs_write_field(serializer, savepoint, "testfield_f0", w_testfield_f0)
      CALL fs_write_field(serializer, savepoint, "testfield_d0", w_testfield_d0)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      
      @assertTrue(fs_field_exists(serializer, "testfield_i0"))
      @assertTrue(fs_field_exists(serializer, "testfield_i1"))
      @assertTrue(fs_field_exists(serializer, "testfield_l0"))
      @assertTrue(fs_field_exists(serializer, "testfield_l1"))
      @assertTrue(fs_field_exists(serializer, "testfield_long0"))
      @assertTrue(fs_field_exists(serializer, "testfield_long1"))
      @assertTrue(fs_field_exists(serializer, "testfield_f0"))
      @assertTrue(fs_field_exists(serializer, "testfield_d0"))
      
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "testfield_i0"))
      @assertEqual(exp_size(SHAPE(w_testfield_i1)), fs_get_size(serializer, "testfield_i1"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "testfield_l0"))
      @assertEqual(exp_size(SHAPE(w_testfield_l1)), fs_get_size(serializer, "testfield_l1"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "testfield_long0"))
      @assertEqual(exp_size(SHAPE(w_testfield_long1)), fs_get_size(serializer, "testfield_long1"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "testfield_f0"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "testfield_d0"))
      
      CALL fs_read_field(serializer, savepoint, "testfield_i0", r_testfield_i0)
      CALL fs_read_field(serializer, savepoint, "testfield_i1", r_testfield_i1)
      CALL fs_read_field(serializer, savepoint, "testfield_l0", r_testfield_l0)
      CALL fs_read_field(serializer, savepoint, "testfield_l1", r_testfield_l1)
      CALL fs_read_field(serializer, savepoint, "testfield_long0", r_testfield_long0)
      CALL fs_read_field(serializer, savepoint, "testfield_long1", r_testfield_long1)
      CALL fs_read_field(serializer, savepoint, "testfield_f0", r_testfield_f0)
      CALL fs_read_field(serializer, savepoint, "testfield_d0", r_testfield_d0)
      
      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_i0, r_testfield_i0)
      @assertEqual(w_testfield_i1, r_testfield_i1)
      @assertEquivalent(w_testfield_l0, r_testfield_l0)
      @assertEquivalent(w_testfield_l1, r_testfield_l1)
      @assertEqual(w_testfield_long0, r_testfield_long0)
      @assertEqual(w_testfield_long1, r_testfield_long1)
      @assertEqual(w_testfield_f0, r_testfield_f0)
      @assertEqual(w_testfield_d0, r_testfield_d0)
    
    END SUBROUTINE testScalars
   
@Test
    SUBROUTINE testRank_i2()
    
      TYPE(t_serializer) :: serializer
      
      INTEGER :: w_testfield_i2a(3,1), r_testfield_i2a(3,1)
      INTEGER :: w_testfield_i2b(1,3), r_testfield_i2b(1,3)
      INTEGER :: w_testfield_i2c(1,1), r_testfield_i2c(1,1)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_rank_2d'
      
      w_testfield_i2a = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i2a))
      w_testfield_i2b = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i2b))
      w_testfield_i2c = RESHAPE((/ 23 /), SHAPE(w_testfield_i2c))
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_i2a_rank", w_testfield_i2a)
      CALL fs_write_field(serializer, savepoint, "testfield_i2b_rank", w_testfield_i2b)
      CALL fs_write_field(serializer, savepoint, "testfield_i2c_rank", w_testfield_i2c)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)

      @assertTrue(fs_field_exists(serializer, "testfield_i2a_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i2b_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i2c_rank"))
      
      @assertEqual(exp_size(SHAPE(w_testfield_i2a)), fs_get_size(serializer, "testfield_i2a_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i2b)), fs_get_size(serializer, "testfield_i2b_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i2c)), fs_get_size(serializer, "testfield_i2c_rank"))
      
      CALL fs_read_field(serializer, savepoint, "testfield_i2a_rank", r_testfield_i2a)
      CALL fs_read_field(serializer, savepoint, "testfield_i2b_rank", r_testfield_i2b)
      CALL fs_read_field(serializer, savepoint, "testfield_i2c_rank", r_testfield_i2c)

      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_i2a, r_testfield_i2a)
      @assertEqual(w_testfield_i2b, r_testfield_i2b)
      @assertEqual(w_testfield_i2c, r_testfield_i2c)
    
    END SUBROUTINE testRank_i2
   
@Test
    SUBROUTINE testRank_i3()
    
      TYPE(t_serializer) :: serializer
      
      INTEGER :: w_testfield_i3a(3,1,4), r_testfield_i3a(3,1,4)
      INTEGER :: w_testfield_i3b(3,4,1), r_testfield_i3b(3,4,1)
      INTEGER :: w_testfield_i3c(3,1,1), r_testfield_i3c(3,1,1)
      INTEGER :: w_testfield_i3d(1,1,1), r_testfield_i3d(1,1,1)
      INTEGER :: w_testfield_i3e(1,1,3), r_testfield_i3e(1,1,3)
      INTEGER :: w_testfield_i3f(1,4,3), r_testfield_i3f(1,4,3)
      INTEGER :: w_testfield_i3g(1,3,1), r_testfield_i3g(1,3,1)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_rank_3d'
      
      w_testfield_i3a = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i3a))
      w_testfield_i3b = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i3b))
      w_testfield_i3c = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i3c))
      w_testfield_i3d = RESHAPE((/ 109 /), SHAPE(w_testfield_i3d))
      w_testfield_i3e = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i3e))
      w_testfield_i3f = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i3f))
      w_testfield_i3g = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i3g))
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_i3a_rank", w_testfield_i3a)
      CALL fs_write_field(serializer, savepoint, "testfield_i3b_rank", w_testfield_i3b)
      CALL fs_write_field(serializer, savepoint, "testfield_i3c_rank", w_testfield_i3c)
      CALL fs_write_field(serializer, savepoint, "testfield_i3d_rank", w_testfield_i3d)
      CALL fs_write_field(serializer, savepoint, "testfield_i3e_rank", w_testfield_i3e)
      CALL fs_write_field(serializer, savepoint, "testfield_i3f_rank", w_testfield_i3f)
      CALL fs_write_field(serializer, savepoint, "testfield_i3g_rank", w_testfield_i3g)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)

      @assertTrue(fs_field_exists(serializer, "testfield_i3a_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3b_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3c_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3d_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3e_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3f_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i3g_rank"))
      
      @assertEqual(exp_size(SHAPE(w_testfield_i3a)), fs_get_size(serializer, "testfield_i3a_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3b)), fs_get_size(serializer, "testfield_i3b_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3c)), fs_get_size(serializer, "testfield_i3c_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3d)), fs_get_size(serializer, "testfield_i3d_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3e)), fs_get_size(serializer, "testfield_i3e_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3f)), fs_get_size(serializer, "testfield_i3f_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i3g)), fs_get_size(serializer, "testfield_i3g_rank"))
      
      CALL fs_read_field(serializer, savepoint, "testfield_i3a_rank", r_testfield_i3a)
      CALL fs_read_field(serializer, savepoint, "testfield_i3b_rank", r_testfield_i3b)
      CALL fs_read_field(serializer, savepoint, "testfield_i3c_rank", r_testfield_i3c)
      CALL fs_read_field(serializer, savepoint, "testfield_i3d_rank", r_testfield_i3d)
      CALL fs_read_field(serializer, savepoint, "testfield_i3e_rank", r_testfield_i3e)
      CALL fs_read_field(serializer, savepoint, "testfield_i3f_rank", r_testfield_i3f)
      CALL fs_read_field(serializer, savepoint, "testfield_i3g_rank", r_testfield_i3g)

      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_i3a, r_testfield_i3a)
      @assertEqual(w_testfield_i3b, r_testfield_i3b)
      @assertEqual(w_testfield_i3c, r_testfield_i3c)
      @assertEqual(w_testfield_i3d, r_testfield_i3d)
      @assertEqual(w_testfield_i3e, r_testfield_i3e)
      @assertEqual(w_testfield_i3f, r_testfield_i3f)
      @assertEqual(w_testfield_i3g, r_testfield_i3g)
    
    END SUBROUTINE testRank_i3
   
@Test
    SUBROUTINE testRank_i4()
    
      TYPE(t_serializer) :: serializer
      
      INTEGER :: w_testfield_i4a(3,1,1,4), r_testfield_i4a(3,1,1,4)
      INTEGER :: w_testfield_i4b(3,2,2,1), r_testfield_i4b(3,2,2,1)
      INTEGER :: w_testfield_i4c(3,2,1,1), r_testfield_i4c(3,2,1,1)
      INTEGER :: w_testfield_i4d(3,1,1,1), r_testfield_i4d(3,1,1,1)
      INTEGER :: w_testfield_i4e(1,1,1,1), r_testfield_i4e(1,1,1,1)
      INTEGER :: w_testfield_i4f(1,1,1,3), r_testfield_i4f(1,1,1,3)
      INTEGER :: w_testfield_i4g(1,1,2,3), r_testfield_i4g(1,1,2,3)
      INTEGER :: w_testfield_i4h(1,3,2,2), r_testfield_i4h(1,3,2,2)
      
      INTEGER :: w_testfield_i4i(3,2,1,2), r_testfield_i4i(3,2,1,2)
      INTEGER :: w_testfield_i4j(3,1,2,2), r_testfield_i4j(3,1,2,2)
      INTEGER :: w_testfield_i4k(1,3,4,1), r_testfield_i4k(1,3,4,1)
      INTEGER :: w_testfield_i4l(1,3,1,1), r_testfield_i4l(1,3,1,1)
      INTEGER :: w_testfield_i4m(1,1,3,1), r_testfield_i4m(1,1,3,1)
      INTEGER :: w_testfield_i4n(1,3,1,4), r_testfield_i4n(1,3,1,4)
      INTEGER :: w_testfield_i4o(3,1,4,1), r_testfield_i4o(3,1,4,1)
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_rank_4d'
      
      w_testfield_i4a = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i4a))
      w_testfield_i4b = RESHAPE((/ 0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11 /), SHAPE(w_testfield_i4b))
      w_testfield_i4c = RESHAPE((/ 0, 4, 8, 1, 5, 9 /), SHAPE(w_testfield_i4c))
      w_testfield_i4d = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i4d))
      w_testfield_i4e = RESHAPE((/ 42 /), SHAPE(w_testfield_i4e))
      w_testfield_i4f = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i4f))
      w_testfield_i4g = RESHAPE((/ 0, 4, 8, 1, 5, 9 /), SHAPE(w_testfield_i4g))
      w_testfield_i4h = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4h))
      w_testfield_i4i = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4i))
      w_testfield_i4j = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4j))
      w_testfield_i4k = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4k))
      w_testfield_i4l = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i4l))
      w_testfield_i4m = RESHAPE((/ 0, 4, 8 /), SHAPE(w_testfield_i4m))
      w_testfield_i4n = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4n))
      w_testfield_i4o = RESHAPE((/ 0, 4, 8, 2, 6, 10, 1, 5, 9, 3, 7, 11 /), SHAPE(w_testfield_i4o))
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "testfield_i4a_rank", w_testfield_i4a)
      CALL fs_write_field(serializer, savepoint, "testfield_i4b_rank", w_testfield_i4b)
      CALL fs_write_field(serializer, savepoint, "testfield_i4c_rank", w_testfield_i4c)
      CALL fs_write_field(serializer, savepoint, "testfield_i4d_rank", w_testfield_i4d)
      CALL fs_write_field(serializer, savepoint, "testfield_i4e_rank", w_testfield_i4e)
      CALL fs_write_field(serializer, savepoint, "testfield_i4f_rank", w_testfield_i4f)
      CALL fs_write_field(serializer, savepoint, "testfield_i4g_rank", w_testfield_i4g)
      CALL fs_write_field(serializer, savepoint, "testfield_i4h_rank", w_testfield_i4h)
      CALL fs_write_field(serializer, savepoint, "testfield_i4i_rank", w_testfield_i4i)
      CALL fs_write_field(serializer, savepoint, "testfield_i4j_rank", w_testfield_i4j)
      CALL fs_write_field(serializer, savepoint, "testfield_i4k_rank", w_testfield_i4k)
      CALL fs_write_field(serializer, savepoint, "testfield_i4l_rank", w_testfield_i4l)
      CALL fs_write_field(serializer, savepoint, "testfield_i4m_rank", w_testfield_i4m)
      CALL fs_write_field(serializer, savepoint, "testfield_i4n_rank", w_testfield_i4n)
      CALL fs_write_field(serializer, savepoint, "testfield_i4o_rank", w_testfield_i4o)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)

      @assertTrue(fs_field_exists(serializer, "testfield_i4a_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4b_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4c_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4d_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4e_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4f_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4g_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4h_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4i_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4j_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4k_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4l_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4m_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4n_rank"))
      @assertTrue(fs_field_exists(serializer, "testfield_i4o_rank"))
      
      @assertEqual(exp_size(SHAPE(w_testfield_i4a)), fs_get_size(serializer, "testfield_i4a_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4b)), fs_get_size(serializer, "testfield_i4b_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4c)), fs_get_size(serializer, "testfield_i4c_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4d)), fs_get_size(serializer, "testfield_i4d_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4e)), fs_get_size(serializer, "testfield_i4e_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4f)), fs_get_size(serializer, "testfield_i4f_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4g)), fs_get_size(serializer, "testfield_i4g_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4h)), fs_get_size(serializer, "testfield_i4h_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4i)), fs_get_size(serializer, "testfield_i4i_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4j)), fs_get_size(serializer, "testfield_i4j_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4k)), fs_get_size(serializer, "testfield_i4k_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4l)), fs_get_size(serializer, "testfield_i4l_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4m)), fs_get_size(serializer, "testfield_i4m_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4n)), fs_get_size(serializer, "testfield_i4n_rank"))
      @assertEqual(exp_size(SHAPE(w_testfield_i4o)), fs_get_size(serializer, "testfield_i4o_rank"))

      CALL fs_read_field(serializer, savepoint, "testfield_i4a_rank", r_testfield_i4a)
      CALL fs_read_field(serializer, savepoint, "testfield_i4b_rank", r_testfield_i4b)
      CALL fs_read_field(serializer, savepoint, "testfield_i4c_rank", r_testfield_i4c)
      CALL fs_read_field(serializer, savepoint, "testfield_i4d_rank", r_testfield_i4d)
      CALL fs_read_field(serializer, savepoint, "testfield_i4e_rank", r_testfield_i4e)
      CALL fs_read_field(serializer, savepoint, "testfield_i4f_rank", r_testfield_i4f)
      CALL fs_read_field(serializer, savepoint, "testfield_i4g_rank", r_testfield_i4g)
      CALL fs_read_field(serializer, savepoint, "testfield_i4h_rank", r_testfield_i4h)
      CALL fs_read_field(serializer, savepoint, "testfield_i4i_rank", r_testfield_i4i)
      CALL fs_read_field(serializer, savepoint, "testfield_i4j_rank", r_testfield_i4j)
      CALL fs_read_field(serializer, savepoint, "testfield_i4k_rank", r_testfield_i4k)
      CALL fs_read_field(serializer, savepoint, "testfield_i4l_rank", r_testfield_i4l)
      CALL fs_read_field(serializer, savepoint, "testfield_i4m_rank", r_testfield_i4m)
      CALL fs_read_field(serializer, savepoint, "testfield_i4n_rank", r_testfield_i4n)
      CALL fs_read_field(serializer, savepoint, "testfield_i4o_rank", r_testfield_i4o)

      CALL fs_destroy_serializer(serializer)
      
      @assertEqual(w_testfield_i4a, r_testfield_i4a)
      @assertEqual(w_testfield_i4b, r_testfield_i4b)
      @assertEqual(w_testfield_i4c, r_testfield_i4c)
      @assertEqual(w_testfield_i4d, r_testfield_i4d)
      @assertEqual(w_testfield_i4e, r_testfield_i4e)
      @assertEqual(w_testfield_i4f, r_testfield_i4f)
      @assertEqual(w_testfield_i4g, r_testfield_i4g)
      @assertEqual(w_testfield_i4h, r_testfield_i4h)
      @assertEqual(w_testfield_i4i, r_testfield_i4i)
      @assertEqual(w_testfield_i4j, r_testfield_i4j)
      @assertEqual(w_testfield_i4k, r_testfield_i4k)
      @assertEqual(w_testfield_i4l, r_testfield_i4l)
      @assertEqual(w_testfield_i4m, r_testfield_i4m)
      @assertEqual(w_testfield_i4n, r_testfield_i4n)
      @assertEqual(w_testfield_i4o, r_testfield_i4o)
    
    END SUBROUTINE testRank_i4
    
@Test
    SUBROUTINE testHalos()
    
      CHARACTER(len=*), PARAMETER :: base_name = 'test_halos'
    
      TYPE(t_serializer) :: serializer
    
      LOGICAL              :: logical0, logical1(2), logical2(2,2), logical3(2,2,2), logical4(2,2,2,2) 
      LOGICAL(KIND=C_BOOL) :: boolean0, boolean1(4), boolean2(4,4), boolean3(4,4,4), boolean4(4,4,4,4)
      INTEGER              :: integer0, integer1(8), integer2(8,8), integer3(8,8,8), integer4(8,8,8,8) 
      INTEGER(KIND=C_LONG) :: longint0, longint1(5), longint2(5,5), longint3(5,5,5), longint4(5,5,5,5) 
      REAL(KIND=C_FLOAT)   :: float0, float1(6),   float2(6,6),   float3(6,6,6),   float4(6,6,6,6) 
      REAL(KIND=C_DOUBLE)  :: double0, double1(7),  double2(7,7),  double3(7,7,7),  double4(7,7,7,7), double4zeros(7,7,7,7)
    
      logical0          = .TRUE.
      logical1(:)       = .TRUE.
      logical2(:,:)     = .TRUE.
      logical3(:,:,:)   = .TRUE.
      logical4(:,:,:,:) = .TRUE.
      boolean0          = .TRUE.
      boolean1(:)       = .TRUE.
      boolean2(:,:)     = .TRUE.
      boolean3(:,:,:)   = .TRUE.
      boolean4(:,:,:,:) = .TRUE.
      integer0          = 42
      integer1(:)       = 42
      integer2(:,:)     = 42
      integer3(:,:,:)   = 42
      integer4(:,:,:,:) = 42
      longint0          = 42
      longint1(:)       = 42
      longint2(:,:)     = 42
      longint3(:,:,:)   = 42
      longint4(:,:,:,:) = 42
      float0            = 109.23
      float1(:)         = 109.23
      float2(:,:)       = 109.23
      float3(:,:,:)     = 109.23
      float4(:,:,:,:)   = 109.23
      double0           = 109.23
      double1(:)        = 109.23
      double2(:,:)      = 109.23
      double3(:,:,:)    = 109.23
      double4(:,:,:,:)  = 109.23
      double4zeros(:,:,:,:) = 109.23
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "logical0", logical0)
      CALL fs_write_field(serializer, savepoint, "logical1", logical1, (/ -1 /), (/ 1 /))
      CALL fs_write_field(serializer, savepoint, "logical2", logical2, (/ -2, -3 /), (/ 2, 3 /))
      CALL fs_write_field(serializer, savepoint, "logical3", logical3, (/ -4, -5, -6 /), (/ 4, 5, 6 /))
      CALL fs_write_field(serializer, savepoint, "logical4", logical4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 16 /))
      CALL fs_write_field(serializer, savepoint, "boolean0", boolean0)
      CALL fs_write_field(serializer, savepoint, "boolean1", boolean1, (/ -1 /), (/ 2 /))
      CALL fs_write_field(serializer, savepoint, "boolean2", boolean2, (/ -2, -3 /), (/ 2, 4 /))
      CALL fs_write_field(serializer, savepoint, "boolean3", boolean3, (/ -4, -5, -6 /), (/ 4, 5, 7 /))
      CALL fs_write_field(serializer, savepoint, "boolean4", boolean4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 17 /))
      CALL fs_write_field(serializer, savepoint, "integer0", integer0)
      CALL fs_write_field(serializer, savepoint, "integer1", integer1, (/ -1 /), (/ 3 /))
      CALL fs_write_field(serializer, savepoint, "integer2", integer2, (/ -2, -3 /), (/ 2, 5 /))
      CALL fs_write_field(serializer, savepoint, "integer3", integer3, (/ -4, -5, -6 /), (/ 4, 5, 8 /))
      CALL fs_write_field(serializer, savepoint, "integer4", integer4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 18 /))
      CALL fs_write_field(serializer, savepoint, "longint0", longint0)
      CALL fs_write_field(serializer, savepoint, "longint1", longint1, (/ -1 /), (/ 4 /))
      CALL fs_write_field(serializer, savepoint, "longint2", longint2, (/ -2, -3 /), (/ 2, 6 /))
      CALL fs_write_field(serializer, savepoint, "longint3", longint3, (/ -4, -5, -6 /), (/ 4, 5, 9 /))
      CALL fs_write_field(serializer, savepoint, "longint4", longint4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 19 /))
      CALL fs_write_field(serializer, savepoint, "float0", float0)
      CALL fs_write_field(serializer, savepoint, "float1", float1, (/ -1 /), (/ 5 /))
      CALL fs_write_field(serializer, savepoint, "float2", float2, (/ -2, -3 /), (/ 2, 7 /))
      CALL fs_write_field(serializer, savepoint, "float3", float3, (/ -4, -5, -6 /), (/ 4, 5, 10 /))
      CALL fs_write_field(serializer, savepoint, "float4", float4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 20 /))
      CALL fs_write_field(serializer, savepoint, "double0", double0)
      CALL fs_write_field(serializer, savepoint, "double1", double1, (/ -1 /), (/ 6 /))
      CALL fs_write_field(serializer, savepoint, "double2", double2, (/ -2, -3 /), (/ 2, 8 /))
      CALL fs_write_field(serializer, savepoint, "double3", double3, (/ -4, -5, -6 /), (/ 4, 5, 11 /))
      CALL fs_write_field(serializer, savepoint, "double4", double4, (/ 7, 23, 12, 0 /), (/ 8, 42, -4, 21 /))
      CALL fs_write_field(serializer, savepoint, "double4zeros", double4zeros)
      CALL fs_destroy_serializer(serializer)      
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "logical0"))
      @assertEqual((/ -1, 1, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "logical1"))
      @assertEqual((/ -2, 2, -3, 3, 0, 0, 0, 0 /),    fs_get_halos(serializer, "logical2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 6, 0, 0 /),   fs_get_halos(serializer, "logical3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 16 /), fs_get_halos(serializer, "logical4"))
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "boolean0"))
      @assertEqual((/ -1, 2, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "boolean1"))
      @assertEqual((/ -2, 2, -3, 4, 0, 0, 0, 0 /),    fs_get_halos(serializer, "boolean2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 7, 0, 0 /),   fs_get_halos(serializer, "boolean3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 17 /), fs_get_halos(serializer, "boolean4"))
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "integer0"))
      @assertEqual((/ -1, 3, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "integer1"))
      @assertEqual((/ -2, 2, -3, 5, 0, 0, 0, 0 /),    fs_get_halos(serializer, "integer2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 8, 0, 0 /),   fs_get_halos(serializer, "integer3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 18 /), fs_get_halos(serializer, "integer4"))
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "longint0"))
      @assertEqual((/ -1, 4, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "longint1"))
      @assertEqual((/ -2, 2, -3, 6, 0, 0, 0, 0 /),    fs_get_halos(serializer, "longint2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 9, 0, 0 /),   fs_get_halos(serializer, "longint3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 19 /), fs_get_halos(serializer, "longint4"))
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "float0"))
      @assertEqual((/ -1, 5, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "float1"))
      @assertEqual((/ -2, 2, -3, 7, 0, 0, 0, 0 /),    fs_get_halos(serializer, "float2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 10, 0, 0 /),  fs_get_halos(serializer, "float3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 20 /), fs_get_halos(serializer, "float4"))
      @assertEqual(exp_halos_scalar,                  fs_get_halos(serializer, "double0"))
      @assertEqual((/ -1, 6, 0, 0, 0, 0, 0, 0 /),     fs_get_halos(serializer, "double1"))
      @assertEqual((/ -2, 2, -3, 8, 0, 0, 0, 0 /),    fs_get_halos(serializer, "double2"))
      @assertEqual((/ -4, 4, -5, 5, -6, 11, 0, 0 /),  fs_get_halos(serializer, "double3"))
      @assertEqual((/ 7, 8, 23, 42, 12, -4, 0, 21 /), fs_get_halos(serializer, "double4"))
      @assertEqual((/ 0, 0, 0, 0, 0, 0, 0, 0 /),      fs_get_halos(serializer, "double4zeros"))
      CALL fs_destroy_serializer(serializer)      
    
    END SUBROUTINE testHalos
    
@Test
    SUBROUTINE testShortname()
    
      TYPE(t_serializer) :: serializer
      INTEGER :: w_testfield_i0, r_testfield_i0
      
      CHARACTER(len=*), PARAMETER :: base_name = 'test_shortname'
      
      w_testfield_i0 = 42
            
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "012345", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "01234", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "0123", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "012", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "01", w_testfield_i0)
      CALL fs_write_field(serializer, savepoint, "0", w_testfield_i0)
      CALL fs_destroy_serializer(serializer)
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertTrue(fs_field_exists(serializer, "012345"))
      @assertTrue(fs_field_exists(serializer, "01234"))
      @assertTrue(fs_field_exists(serializer, "0123"))
      @assertTrue(fs_field_exists(serializer, "012"))
      @assertTrue(fs_field_exists(serializer, "01"))
      @assertTrue(fs_field_exists(serializer, "0"))
      
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "012345"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "01234"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "0123"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "012"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "01"))
      @assertEqual(exp_size_scalar, fs_get_size(serializer, "0"))
      
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "012345"))
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "01234"))
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "0123"))
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "012"))
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "01"))
      @assertEqual(exp_halos_scalar, fs_get_halos(serializer, "0"))
    
    END SUBROUTINE testShortname    
    
@Test
    SUBROUTINE testRank()
    
      CHARACTER(len=*), PARAMETER :: base_name = 'test_rank'
    
      TYPE(t_serializer) :: serializer
    
      INTEGER              :: integer0, integer1(1), integer2(1,1), integer3(1,1,1), integer4(1,1,1,1) 
    
      integer0          = 42
      integer1(:)       = 42
      integer2(:,:)     = 42
      integer3(:,:,:)   = 42
      integer4(:,:,:,:) = 42

      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "integer0", integer0)
      CALL fs_write_field(serializer, savepoint, "integer1", integer1)
      CALL fs_write_field(serializer, savepoint, "integer2", integer2)
      CALL fs_write_field(serializer, savepoint, "integer3", integer3)
      CALL fs_write_field(serializer, savepoint, "integer4", integer4)
      CALL fs_destroy_serializer(serializer)      
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertEqual(1, fs_get_rank(serializer, "integer0"))
      @assertEqual(1, fs_get_rank(serializer, "integer1"))
      @assertEqual(2, fs_get_rank(serializer, "integer2"))
      @assertEqual(3, fs_get_rank(serializer, "integer3"))
      @assertEqual(4, fs_get_rank(serializer, "integer4"))
      CALL fs_destroy_serializer(serializer)      
    
    END SUBROUTINE testRank
    
@Test
    SUBROUTINE testTotalSize()
    
      CHARACTER(len=*), PARAMETER :: base_name = 'test_rank'
    
      TYPE(t_serializer) :: serializer
    
      INTEGER              :: integer0, integer1(42), integer2(6,7), integer3(6,1,7), integer4(1,2,3,4) 
    
      integer0          = 42
      integer1(:)       = 42
      integer2(:,:)     = 42
      integer3(:,:,:)   = 42
      integer4(:,:,:,:) = 42

      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, "integer0", integer0)
      CALL fs_write_field(serializer, savepoint, "integer1", integer1)
      CALL fs_write_field(serializer, savepoint, "integer2", integer2)
      CALL fs_write_field(serializer, savepoint, "integer3", integer3)
      CALL fs_write_field(serializer, savepoint, "integer4", integer4)
      CALL fs_destroy_serializer(serializer)      
      
      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      @assertEqual(1, fs_get_total_size(serializer, "integer0"))
      @assertEqual(42, fs_get_total_size(serializer, "integer1"))
      @assertEqual(42, fs_get_total_size(serializer, "integer2"))
      @assertEqual(42, fs_get_total_size(serializer, "integer3"))
      @assertEqual(24, fs_get_total_size(serializer, "integer4"))
      CALL fs_destroy_serializer(serializer)      
    
    END SUBROUTINE testTotalSize

@Test
    SUBROUTINE testGlobalMetainfo()
    
      TYPE(t_serializer) :: serializer
      CHARACTER(len=*), PARAMETER :: base_name = 'test_global_metainfo'

      LOGICAL              :: metalog
      INTEGER(KIND=C_INT)  :: metaint
      INTEGER(KIND=C_LONG) :: metalong
      REAL(KIND=C_FLOAT)   :: metafloat
      REAL(KIND=C_DOUBLE)  :: metadouble
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metalog-t', .TRUE.)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metalog-f', .FALSE.)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metaint', 42)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metalong', -109470000042_8)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metafloat', 23.0_4)
      CALL fs_add_serializer_metainfo(serializer, 'ser-metadouble', 109.47_8)
      CALL fs_destroy_serializer(serializer)

      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metalog-t', metalog)
      @assertEqual(.TRUE., metalog)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metalog-f', metalog)
      @assertEqual(.FALSE., metalog)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metaint', metaint)
      @assertEqual(42, metaint)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metalong', metalong)
      @assertEqual(-109470000042_8, metalong)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metafloat', metafloat)
      @assertEqual(23.0_4, metafloat)
      CALL fs_get_serializer_metainfo(serializer, 'ser-metadouble', metadouble)
      @assertEqual(109.47_8, metadouble)
      CALL fs_destroy_serializer(serializer)
    
    END SUBROUTINE testGlobalMetainfo    

@Test
    SUBROUTINE testFieldMetainfo()
    
      TYPE(t_serializer) :: serializer
      CHARACTER(len=*), PARAMETER :: base_name = 'test_field_metainfo'
      INTEGER :: field(2,1,4)      
      CHARACTER(len=*), PARAMETER :: field_name = 'field'
      
      LOGICAL              :: metalog
      INTEGER(KIND=C_INT)  :: metaint
      INTEGER(KIND=C_LONG) :: metalong
      REAL(KIND=C_FLOAT)   :: metafloat
      REAL(KIND=C_DOUBLE)  :: metadouble
      
      field = RESHAPE((/ 0, 1, 2, 3, 4, 5, 6, 7 /), SHAPE(field))
      
      CALL fs_create_serializer(dir, base_name, 'w', serializer)
      CALL fs_write_field(serializer, savepoint, field_name, field)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metalog-t', .TRUE.)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metalog-f', .FALSE.)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metaint', 42)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metalong', -109470000042_8)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metafloat', 23.0_4)
      CALL fs_add_field_metainfo(serializer, field_name, 'field-metadouble', 109.47_8)
      CALL fs_destroy_serializer(serializer)

      CALL fs_create_serializer(dir, base_name, 'r', serializer)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metalog-t', metalog)
      @assertEqual(.TRUE., metalog)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metalog-f', metalog)
      @assertEqual(.FALSE., metalog)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metaint', metaint)
      @assertEqual(42, metaint)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metalong', metalong)
      @assertEqual(-109470000042_8, metalong)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metafloat', metafloat)
      @assertEqual(23.0_4, metafloat)
      CALL fs_get_field_metainfo(serializer, field_name, 'field-metadouble', metadouble)
      @assertEqual(109.47_8, metadouble)
      CALL fs_destroy_serializer(serializer)

    END SUBROUTINE testFieldMetainfo    

@Test
    SUBROUTINE testSavepointMetainfo()
    
      TYPE(t_savepoint) :: savepoint
      CHARACTER(len=*), PARAMETER :: savepoint_name = 'test_savepoint_metainfo'
      
      LOGICAL              :: metalog
      INTEGER(KIND=C_INT)  :: metaint
      INTEGER(KIND=C_LONG) :: metalong
      REAL(KIND=C_FLOAT)   :: metafloat
      REAL(KIND=C_DOUBLE)  :: metadouble
      
      CALL fs_create_savepoint(savepoint_name, savepoint)
      
      CALL fs_add_savepoint_metainfo(savepoint, 'metalog-t', .TRUE.)
      CALL fs_add_savepoint_metainfo(savepoint, 'metalog-f', .FALSE.)
      CALL fs_add_savepoint_metainfo(savepoint, 'metaint', 42)
      CALL fs_add_savepoint_metainfo(savepoint, 'metalong', -109470000042_8)
      CALL fs_add_savepoint_metainfo(savepoint, 'metafloat', 23.0_4)
      CALL fs_add_savepoint_metainfo(savepoint, 'metadouble', 109.47_8)

      CALL fs_get_savepoint_metainfo(savepoint, 'metalog-t', metalog)
      @assertEqual(.TRUE., metalog)
      CALL fs_get_savepoint_metainfo(savepoint, 'metalog-f', metalog)
      @assertEqual(.FALSE., metalog)
      CALL fs_get_savepoint_metainfo(savepoint, 'metaint', metaint)
      @assertEqual(42, metaint)
      CALL fs_get_savepoint_metainfo(savepoint, 'metalong', metalong)
      @assertEqual(-109470000042_8, metalong)
      CALL fs_get_savepoint_metainfo(savepoint, 'metafloat', metafloat)
      @assertEqual(23.0_4, metafloat)
      CALL fs_get_savepoint_metainfo(savepoint, 'metadouble', metadouble)
      @assertEqual(109.47_8, metadouble)

      CALL fs_destroy_savepoint(savepoint)
    
    END SUBROUTINE testSavepointMetainfo    

END MODULE serialbox_test
